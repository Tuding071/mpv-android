name: Android mpv Build (Full)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout your repo
      uses: actions/checkout@v3

    - name: ğŸ§© Clone official upstream repo for include files
      run: |
        git clone --depth 1 https://github.com/mpv-android/mpv-android.git upstream
        mkdir -p buildscripts/include
        cp -r upstream/buildscripts/include/* buildscripts/include/

    - name: ğŸ“ Setup deps folders
      run: mkdir -p buildscripts/deps

    - name: ğŸ“¦ Clone all dependencies
      run: |
        cd buildscripts/deps
        git clone --depth 1 https://github.com/mpv-player/mpv.git mpv
        git clone --depth 1 https://git.ffmpeg.org/ffmpeg.git ffmpeg
        git clone --depth 1 https://github.com/libass/libass.git libass
        git clone --depth 1 https://github.com/warmcat/libwebsockets.git libwebsockets || true
        git clone --depth 1 https://github.com/videolan/dav1d.git dav1d
        git clone --depth 1 https://github.com/Mbed-TLS/mbedtls.git mbedtls
        git clone --depth 1 https://github.com/luaj/luaj.git lua
        git clone --depth 1 https://code.videolan.org/videolan/libplacebo.git libplacebo
        cd ../..

    - name: âš™ï¸ Install Android SDK & NDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: latest
        ndk-version: 26.1.10909125

    - name: ğŸ”§ Setup build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build meson cmake pkg-config python3 python3-pip gettext yasm nasm

    - name: ğŸ—ï¸ Build mbedtls manually (since make clean fails)
      run: |
        cd buildscripts/deps/mbedtls
        cmake -B build -DCMAKE_POSITION_INDEPENDENT_CODE=ON -DCMAKE_BUILD_TYPE=Release
        cmake --build build -j$(nproc)
        cd ../../..

    - name: ğŸ—ï¸ Build libmpv for ARM64
      run: |
        cd buildscripts
        chmod +x ../gradlew
        ./buildall.sh --arch arm64 mpv
        cd ..

    - name: ğŸ“± Build Android APK
      run: ./gradlew assembleRelease

    - name: ğŸ“¦ Upload APK artifact
      uses: actions/upload-artifact@v3
      with:
        name: mpv-android-arm64
        path: app/build/outputs/apk/release/app-release.apk
