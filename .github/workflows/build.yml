name: Build MPV-Android

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set up Python 3
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip git cmake ninja-build gettext yasm nasm libjsoncpp25 librhash0

      - name: Install Meson
        run: |
          python3 -m pip install --user meson==1.9.1

      # --- Ensure missing include scripts exist ---
      - name: Fetch missing include scripts
        run: |
          mkdir -p buildscripts/include
          curl -L -o buildscripts/include/depinfo.sh https://raw.githubusercontent.com/mpv-android/mpv-android/master/buildscripts/include/depinfo.sh
          curl -L -o buildscripts/include/path.sh https://raw.githubusercontent.com/mpv-android/mpv-android/master/buildscripts/include/path.sh
          curl -L -o buildscripts/include/download-deps.sh https://raw.githubusercontent.com/mpv-android/mpv-android/master/buildscripts/include/download-deps.sh
          curl -L -o buildscripts/include/download-sdk.sh https://raw.githubusercontent.com/mpv-android/mpv-android/master/buildscripts/include/download-sdk.sh
          chmod +x buildscripts/include/*.sh

      - name: Setup Android NDK (r26d)
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d

      - name: Prepare build directories
        run: mkdir -p buildscripts/deps

      - name: Clone dependencies
        run: |
          cd buildscripts/deps
          git clone --depth 1 https://github.com/mpv-android/mpv-android.git mpv
          git clone --depth 1 https://github.com/mpv-android/FFmpeg.git ffmpeg
          git clone --depth 1 https://github.com/libass/libass.git libass
          git clone --depth 1 https://github.com/lua/lua.git lua
          git clone --depth 1 https://github.com/haasn/Libplacebo.git libplacebo
          git clone --depth 1 https://github.com/ARMmbed/mbedtls.git mbedtls
          git clone --depth 1 https://code.videolan.org/videolan/dav1d.git dav1d

      - name: Make build scripts executable
        run: chmod +x buildscripts/buildall.sh buildscripts/scripts/*.sh

      - name: Build libmpv for arm64
        run: |
          cd buildscripts
          ./buildall.sh --arch arm64 mpv

      - name: List APK outputs
        run: ls -lh app/build/outputs/apk/**/

      - name: Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: mpv-apks
          path: app/build/outputs/apk/**/app-*-debug.apk
