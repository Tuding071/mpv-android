name: Build MPV Android

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: r26d
      ANDROID_SDK_ROOT: /tmp/android-sdk

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up JDK
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: 17

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git unzip zip wget cmake ninja-build meson nasm yasm gettext libjsoncpp25 librhash0

    - name: Set up NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk: ${{ env.ANDROID_NDK_VERSION }}

    - name: Prepare deps folder
      run: mkdir -p buildscripts/deps

    - name: Clone dependencies
      run: |
        cd buildscripts/deps
        git clone --depth 1 https://github.com/mpv-android/mpv-android.git mpv
        git clone --depth 1 https://github.com/FFmpeg/FFmpeg.git ffmpeg
        git clone --depth 1 https://github.com/libass/libass.git libass
        git clone --depth 1 https://github.com/lua/lua.git lua
        git clone --depth 1 https://github.com/haasn/Libplacebo.git libplacebo
        git clone --depth 1 https://github.com/ARMmbed/mbedtls.git mbedtls
        git clone --depth 1 https://code.videolan.org/videolan/dav1d.git dav1d

    - name: Copy include scripts
      run: |
        cp -r upstream/buildscripts/include buildscripts/

    - name: Make build scripts executable
      run: chmod +x buildscripts/buildall.sh buildscripts/scripts/*.sh

    - name: Build libmpv for arm64
      run: |
        cd buildscripts
        ./buildall.sh --arch arm64 mpv

    - name: Package APKs
      run: |
        cd app/build/outputs/apk
        zip -r $GITHUB_WORKSPACE/mpv-apks.zip .

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: mpv-apks
        path: $GITHUB_WORKSPACE/mpv-apks.zip
