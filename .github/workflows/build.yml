name: Android mpv Build (Full Fixed)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Checkout your repo
      uses: actions/checkout@v4

    - name: 🧩 Clone official upstream repo for include + scripts
      run: |
        git clone --depth 1 https://github.com/mpv-android/mpv-android.git upstream
        mkdir -p buildscripts/include buildscripts/scripts
        cp -r upstream/buildscripts/include/* buildscripts/include/
        cp -r upstream/buildscripts/scripts/* buildscripts/scripts/

    - name: 📁 Setup deps folders
      run: mkdir -p buildscripts/deps

    - name: 📦 Clone all dependencies
      run: |
        cd buildscripts/deps
        git clone --depth 1 https://github.com/mpv-player/mpv.git mpv
        git clone --depth 1 https://git.ffmpeg.org/ffmpeg.git ffmpeg
        git clone --depth 1 https://github.com/libass/libass.git libass
        git clone --depth 1 https://github.com/videolan/dav1d.git dav1d
        git clone --depth 1 https://github.com/Mbed-TLS/mbedtls.git mbedtls
        git clone --depth 1 https://github.com/luaj/luaj.git lua
        git clone --depth 1 https://code.videolan.org/videolan/libplacebo.git libplacebo

        # Initialize submodules for mbedtls and others if any
        cd mbedtls
        git submodule update --init --recursive || true
        cd ../..

    - name: ⚙️ Setup Android SDK & NDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: latest
        ndk-version: 26.1.10909125

    - name: 🔧 Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build meson cmake pkg-config python3 python3-pip gettext yasm nasm autoconf automake libtool git

    - name: 🏗️ Build libmpv (arm64)
      run: |
        cd buildscripts
        chmod +x ../gradlew
        ./buildall.sh --arch arm64 mpv
        cd ..

    - name: 📱 Build Android APK
      run: ./gradlew assembleRelease

    - name: 📦 Upload built APK
      uses: actions/upload-artifact@v4
      with:
        name: mpv-android-arm64
        path: app/build/outputs/apk/release/app-release.apk
