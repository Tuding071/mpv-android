name: Build mpv-android

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  ANDROID_NDK_VERSION: r26d
  ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk
  DEPS_DIR: ${{ github.workspace }}/buildscripts/deps
  INCLUDE_DIR: ${{ github.workspace }}/buildscripts/include
  BUILD_DIR: ${{ github.workspace }}/buildscripts

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Set up dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libjsoncpp25 librhash0 cmake-data cmake gettext ninja-build meson nasm yasm unzip wget git

    - name: Set up NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: ${{ env.ANDROID_NDK_VERSION }}
        add-to-path: true

    - name: Prepare buildscripts
      run: |
        mkdir -p $DEPS_DIR
        git clone --depth 1 https://github.com/mpv-android/mpv-android.git upstream
        cp -r upstream/buildscripts/include/* $INCLUDE_DIR/

    - name: Clone dependencies
      run: |
        cd $DEPS_DIR
        git clone --depth 1 https://github.com/mpv-android/mpv-android.git mpv
        git clone --depth 1 https://github.com/mpv-android/FFmpeg ffmpeg
        git clone --depth 1 https://github.com/libass/libass libass
        git clone --depth 1 https://github.com/lua/lua lua
        git clone --depth 1 https://github.com/haasn/mbedtls mbedtls
        git clone --depth 1 https://code.videolan.org/videolan/dav1d.git dav1d
        git clone --depth 1 https://github.com/Plagman/libplacebo.git libplacebo

    - name: Make scripts executable
      run: |
        chmod +x $BUILD_DIR/buildall.sh
        chmod +x $BUILD_DIR/include/*.sh
        chmod +x $BUILD_DIR/scripts/*.sh

    - name: Build libmpv (arm64)
      run: |
        cd $BUILD_DIR
        ./buildall.sh --arch arm64 mpv

    - name: List APKs
      run: |
        ls -lh ../app/build/outputs/apk/**/

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: mpv-apks
        path: ../app/build/outputs/apk/**/*.apk
